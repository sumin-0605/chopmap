<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bible Quest · Mobile</title>
  <link href="https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f1a; --bg-soft:#0f1526; --panel:#121a2f;
      --ink:#f5f7ff; --ink-dim:#c8d0ff; --accent:#79a6ff; --accent-2:#ffd66e;
      --ok:#86efac; --warn:#fca5a5; --pixel:4px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -200px, #1a2547 0%, var(--bg) 50%, #060911 100%);
      color:var(--ink);
      font-family:"Galmuri11",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,sans-serif;
      letter-spacing:.2px;
    }
    body.lock{overflow:hidden; overscroll-behavior:contain}
    .wrap{max-width:480px; margin:0 auto; padding:12px}

    .hud{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg, rgba(10,14,27,.85), rgba(10,14,27,.35));
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    .panel{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      margin-top:1rem;
    }

    .cta{
      display:inline-flex; align-items:center; gap:8px;
      padding:12px 16px; font-weight:700; text-transform:uppercase;
      border:2px solid var(--ink);
      background:linear-gradient(180deg,#1f2c55,#152041);
      border-radius:12px; cursor:pointer; text-decoration:none; color:var(--ink);
    }
    .cta:active{transform:translateY(1px)}
    .cta.blink{animation:blink 1s step-end infinite}
    @keyframes blink{50%{opacity:.45}}

    .pixel{ position:relative; border:var(--pixel) solid #2a3c73; box-shadow:0 0 0 calc(var(--pixel)*2) #18234a,0 0 0 calc(var(--pixel)*3) #0e1633; border-radius:10px }

    #introScreen{ display:grid; place-items:center; min-height:77.5dvh; text-align:center; gap:18px }
    .title{ font-size:28px; line-height:1.1; letter-spacing:.5px; text-shadow:0 2px 0 #08102a,0 4px 14px rgba(121,166,255,.55) }
    .subtitle{ color:var(--ink-dim); font-size:12px; opacity:.9 }

    /* 스탯 영역 */
    .meters{ display:grid; grid-template-columns:1fr; gap:20px; padding:10px 12px; overflow:hidden; max-height:500px; transition:max-height .38s ease, padding .38s ease, opacity .25s ease, transform .38s ease }
    .meters.collapsed{ max-height:0; padding-top:0; padding-bottom:0; opacity:0; transform:translateY(-8px); pointer-events:none }
    .bar{ background:#0c1327; border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:hidden; height:22px; position:relative }
    .bar>.fill{ height:100%; width:0%; transition:width .45s ease; background:linear-gradient(90deg,#4f7cff,#6fa8ff 60%,#a4c6ff); box-shadow: inset 0 0 12px rgba(121,166,255,.65) }
    .bar.hp>.fill{ background:linear-gradient(90deg,#2ed47a,#54ef9b 60%,#9bf4c4) }
    .bar.mp>.fill{ background:linear-gradient(90deg,#a78bfa,#c4b5fd 60%,#e9d5ff) }
    .bar .label{ position:absolute; inset:0; display:grid; place-items:center; font-size:10px; color:#e9edff; text-shadow:0 1px 0 #000; line-height:1 }

    #mapScreen{ display:none }
    .map{ display:grid; gap:12px; margin:16px 0 }

    .stage{
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
      padding:12px; background:var(--bg-soft);
      border:1px dashed rgba(255,255,255,.18); border-radius:12px; position:relative;
    }
    /* 오늘 강조 업그레이드 */
    .stage.today{
      border: 1px solid rgba(255,214,110,.95);
      box-shadow:
        0 0 0 2px rgba(255,214,110,.28) inset,
        0 0 34px rgba(255,214,110,.45),
        0 0 2px rgba(255,214,110,.9) inset;
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(255,214,110,.1), transparent 42%),
        var(--bg-soft);
      animation: todayGlow 2.2s ease-in-out infinite;
    }
    @keyframes todayGlow{
      0%,100%{ box-shadow:0 0 0 2px rgba(255,214,110,.28) inset, 0 0 24px rgba(255,214,110,.35), 0 0 2px rgba(255,214,110,.9) inset }
      50%{ box-shadow:0 0 0 2px rgba(255,214,110,.32) inset, 0 0 44px rgba(255,214,110,.55), 0 0 2px rgba(255,214,110,1) inset }
    }
    .today-badge{
      position:absolute; top:-8px; right:8px;
      background:var(--accent-2); color:#111; font-weight:900; font-size:11px;
      padding:3px 8px; border-radius:999px; box-shadow:0 2px 10px rgba(255,214,110,.35);
    }
    .stage.locked{opacity:.85}
    .stage .node{ position:relative; width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:#1f2a4b; border:2px solid #92abff; font-weight:800 }
    .stage.today .node{ transform:scale(1.12); border-color:#ffd66e; box-shadow:0 0 12px rgba(255,214,110,.55); background: radial-gradient(80% 80% at 30% 20%, rgba(255,214,110,.45), #1f2a4b 55%) }
    .stage.today .node::after{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      box-shadow:0 0 0 0 rgba(255,214,110,.55);
      animation:pulseRing 1.6s ease-out infinite;
    }
    @keyframes pulseRing{
      0%{ box-shadow:0 0 0 0 rgba(255,214,110,.55) }
      100%{ box-shadow:0 0 0 14px rgba(255,214,110,0) }
    }
    .stage .info{display:grid; gap:2px}
    .stage .info .day{font-size:12px; color:var(--ink-dim)}
    .stage .info .text{font-size:14px}
    .stage .reward{font-size:11px; color:#cfe0ff; opacity:.85}
    .stage .clear{font-size:11px; color:var(--ok); display:none}
    .stage.cleared .clear{display:inline}
    .go{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg,#22305d,#17254a); color:var(--ink); font-weight:800; cursor:pointer }
    .stage.today .go{ outline:2px solid rgba(255,214,110,.65) }
    .go.primary{ background:linear-gradient(180deg,#ffd66e,#f2c655); color:#1a1410; border-color:rgba(0,0,0,.1); box-shadow:0 6px 18px rgba(255,214,110,.25); animation:bump 1.4s ease-in-out infinite }
    @keyframes bump { 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(-1px)} }
    .go.lock{ opacity:.5; cursor:not-allowed; filter:grayscale(40%) }

    .prefs{ display:flex; gap:8px; flex-wrap:wrap; padding:0 12px 8px }
    .pref-btn{ cursor:pointer; user-select:none }

    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.8); opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:40; backdrop-filter:blur(2px) }
    #overlay.active{ opacity:1; pointer-events:auto }
    /* 힌트 모달 집중용 */
    #overlay.front{ z-index:58; background: rgba(0,0,0,.86); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }

    /* 바텀시트들 공통 (가챠 제거) */
    #questPanel, #boardPanel{
      position:fixed; inset:auto 0 0 0; transform:translateY(105%);
      transition:transform .35s ease; background:#0b1228;
      border-top:1px solid rgba(255,255,255,.1); box-shadow:0 -10px 30px rgba(0,0,0,.55); z-index:50;
    }
    #questPanel.open, #boardPanel.open{ transform:translateY(0%) }

    /* 시트 내부 스크롤 */
    #questPanel .quest-body{ max-height:78dvh; overflow:auto }
    #boardPanel .quest-body{ max-height:78dvh; overflow:auto }

    .quest-body{ padding:16px; display:grid; gap:12px }
    .quest-title{ font-size:18px; font-weight:900 }
    .quest-sub{ color:var(--ink-dim); font-size:12px }
    .quest-grid{ display:grid; gap:10px }
    .q-row{ display:grid; gap:6px }

    .chip{ display:inline-flex; gap:6px; align-items:center; padding:8px 10px; background:#131c38; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:12px; color:var(--ink) }

    .btns{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    .btn{ padding:12px; border-radius:12px; font-weight:800; text-align:center; cursor:pointer; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg,#1f2c55,#152041); color:var(--ink) }
    .btn.warn{ background:linear-gradient(180deg,#3a1c22,#2a1116); border-color:rgba(255,99,99,.35); color:#ffb1b1 }
    .btn.ok{ background:linear-gradient(180deg,#1f3a2a,#152a1e); border-color:rgba(134,239,172,.35); color:#caffe1 }

    #toast{ position:fixed; left:50%; bottom:92px; transform:translateX(-50%) translateY(20px); background:rgba(20,28,56,.9); color:#fff; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; z-index:60 }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

    .confetti-piece{ position:fixed; top:50%; left:50%; width:6px; height:12px; transform-origin:center; pointer-events:none; z-index:60; opacity:0; animation:confetti-pop 700ms ease-out forwards }
    @keyframes confetti-pop{ 0%{opacity:0; transform:translate(-50%,-50%) rotate(0deg) scale(.8)} 100%{opacity:1; transform:translate(var(--dx),var(--dy)) rotate(var(--rot)) scale(1)} }
    .shake{ animation:shakeX .35s ease }
    @keyframes shakeX{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }

    .hidden{ display:none!important }
    @supports(padding:max(0px)){ #questPanel,#boardPanel{ padding-bottom:max(14px, env(safe-area-inset-bottom)) } }

    .link,.link:link,.link:visited{ color:var(--accent-2); text-decoration:none; font-weight:800 }
    .link:hover{ text-decoration:underline; text-underline-offset:2px }

    .topbar{ display:flex; align-items:center; gap:8px; padding:12px }
    .topbar .meta{ flex:1; min-width:0 }
    #resetBtn{ margin-left:auto; white-space:nowrap }

    .hud-ctrl{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; padding:8px 0 4px }

    /* 힌트 모달 (오답 3회 시) */
    .hint-modal{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.96);
      width: min(92vw, 420px);
      background:#0b1228; border:1px solid rgba(255,255,255,.12);
      box-shadow:0 14px 36px rgba(0,0,0,.55);
      border-radius:14px; z-index:60; padding:16px;
      opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
    }
    .hint-modal.show{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1) }
    .hint-title{ font-weight:900; margin-bottom:6px }
    .hint-text{ color:var(--ink-dim); font-size:13px; line-height:1.4 }
    .hint-btns{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px }
  </style>
</head>
<body>
  <div class="hud">
    <div class="wrap">
      <div class="hud-ctrl">
        <button id="nameBtn" class="chip pref-btn">🙋 닉네임: <strong id="nameLabel">게스트</strong></button>
        <button id="boardBtn" class="chip pref-btn">🏆 리더보드</button>
        <button id="statsToggleBtn" class="chip pref-btn">📊 내 스탯 보기</button>
      </div>
      <div class="meters">
        <div class="bar hp pixel" aria-label="믿음(HP)">
          <div class="fill" id="hpFill"></div>
          <div class="label"><span id="hpLabel">HP 0/700</span></div>
        </div>
        <div class="bar mp pixel" aria-label="기도력(MP)">
          <div class="fill" id="mpFill"></div>
          <div class="label"><span id="mpLabel">MP 0/700</span></div>
        </div>
        <div class="bar xp pixel" aria-label="지혜(EXP)">
          <div class="fill" id="xpFill"></div>
          <div class="label"><span id="xpLabel">EXP 0/0</span></div>
        </div>
      </div>
    </div>
  </div>

  <section id="introScreen" class="wrap">
    <div class="panel pixel" style="padding:28px 18px; margin-top: 5rem;">
      <div class="title">✝️ BIBLE QUEST</div>
      <div class="subtitle" style="margin-top: 15px; font-size: 15px;">시편에서 잠언으로, 한 주간의 지혜 여정!</div>
      <div style="height:15px;"></div>
      <a id="startBtn" class="cta blink" href="#">PRESS START</a>
      <div style="height:15px"></div>
      <div class="subtitle" style="font-size: 10px;">모바일 기준 · iPhone SE 너비 최적화<br/>(기기에 따라 비율이 조금 틀어질 수 있습니다!)</div>
    </div>
    <div class="prefs" style="margin-top: 2rem;">
      <button id="soundToggle" class="chip pref-btn">🔊 사운드: <strong id="soundLabel" style="margin-left:6px;">OFF</strong></button>
    </div>
  </section>

  <section id="mapScreen" class="wrap">
    <div class="topbar">
      <div class="meta">
        <div style="font-weight:900;font-size:14px">🗺️ 스테이지 맵 (월→일)</div>
      </div>
      <a id="resetBtn" class="link" href="#">진행 초기화</a>
    </div>
    <div id="stageList" class="map"></div>
  </section>

  <div id="overlay"></div>
  <div id="toast"></div>

  <!-- 힌트 모달 (오답 3회 이상) -->
  <div id="hintModal" class="hint-modal hidden">
    <div class="hint-title">💡 힌트가 도착했어요</div>
    <div id="hintText" class="hint-text">정답을 다시 생각해볼까요?</div>
    <div class="hint-btns">
      <a id="readAgainBtn" class="btn" target="_blank" rel="noopener">본문 다시 읽기</a>
      <button id="closeHintBtn" class="btn ok">계속 풀기</button>
    </div>
  </div>

  <!-- 퀘스트 패널 -->
  <aside id="questPanel" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="quest-body wrap">
      <div class="quest-title" id="qpTitle">MAIN QUEST</div>
      <div class="quest-sub" id="qpSub">오늘의 본문을 읽고 완료로 표시해요!</div>

      <div class="quest-grid">
        <div class="q-row">
          <div class="chip">📖 <span id="qpRange">시편 132–134편</span></div>
          <div class="chip">🏆 보상: <span id="qpReward">+100 EXP</span></div>
        </div>
        <div class="q-row"><a id="qpReadLink" class="cta" target="_blank" rel="noopener">본문 읽기 열기</a></div>
      </div>

      <div id="quizBox" class="panel pixel hidden" style="margin-top:10px;">
        <div style="font-weight:900;margin-bottom:6px;">🧩 단어 퀴즈</div>
        <div id="quizQuestion" class="subtitle" style="margin-bottom:10px;">오늘 본문에서 핵심 단어를 맞혀보세요!</div>
        <input id="quizInput" type="text" placeholder="정답 단어 입력"
          style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1327;color:#e9edff;font-family:inherit;">
        <div class="small" style="margin-top:6px;color:#c8d0ff;">정확한 단어를 입력해야 통과!</div>
        <div class="btns" style="margin-top:10px;">
          <button id="submitQuiz" class="btn ok">정답 제출</button>
          <button id="cancelQuiz" class="btn">취소</button>
        </div>
      </div>

      <div id="actionBtns" class="btns" style="margin-top:10px;">
        <button id="markDoneBtn" class="btn ok">🧩 퀴즈 풀고 완료</button>
        <button id="closePanelBtn" class="btn">닫기</button>
      </div>
    </div>
  </aside>

  <!-- 리더보드 패널 -->
  <aside id="boardPanel" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="quest-body wrap">
      <div class="quest-title">🏆 리더보드</div>
      <div class="quest-sub">상위 10명 · 내 기록은 ★로 표시돼요</div>
      <ol id="boardList" style="margin:6px 0 12px; padding-left:18px;"></ol>
      <div class="btns"><button id="closeBoardBtn" class="btn">닫기</button></div>
    </div>
  </aside>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // --- DATA ---
    const STAGES = [
      { id:1, dayKo:'월', title:'성전에 올라 찬양하라', range:'시편 132–134편', exp:100,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=132&sec=1',
        quizzes:[
          { q:'시편 132–134편 핵심 단어?', a:['시온','시온산'], h:'“순례의 노래”가 가리키는 장소 👀 초성 (ㅅㅇ / ㅅㅇㅅ)' },
          { q:'시편 133편의 주제 한 단어?', a:['연합'], h:'보라 형제가 (ㅇㅎ)하여 동거함이 어찌 그리 선하고…' }
        ]
      },
      { id:2, dayKo:'화', title:'바벨론 강가의 노래', range:'시편 135–137편', exp:150,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=135&sec=1',
        quizQ:'시편 137편에서 시인들이 그리워한 도시는?', quizA:['예루살렘'], hint:'그리운 ㅇㄹㅅㄹ, 따스한 시온성 위에~'
      },
      { id:3, dayKo:'수', title:'주께서 나를 보호하시다', range:'시편 138–140편', exp:200,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=138&sec=1',
        quizQ:'시편 139편의 주제: “주께서는 내 (   )을 알고 계십니다.” 빈칸은?', quizA:['생각','생각들']
      },
      { id:4, dayKo:'목', title:'시험에서 구하소서', range:'시편 141–143편', exp:150,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=141&sec=1',
        quizQ:'시편 143편에서 시인은 무엇에서 인도해 달라고 기도할까요? (한 단어)', quizA:['환난','고난']
      },
      { id:5, dayKo:'금', title:'하나님은 나의 피난처', range:'시편 144–146편', exp:200,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=144&sec=1',
        quizQ:'시편 144–146편에서 반복되는 감탄사는?', quizA:['할렐루야']
      },
      { id:6, dayKo:'토', title:'지혜의 서막', range:'시편 147편 – 잠언 1장', exp:250,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=147&sec=1',
        quizQ:'잠언 1장 7절: 지식의 근본은 “여호와를 (   )하는 것”. 빈칸은?', quizA:['경외']
      },
      { id:7, dayKo:'일', title:'지혜의 길을 선택하라', range:'잠언 2–6장', exp:250,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=pro&chap=2&sec=1',
        quizQ:'잠언에서 강조하는 길은? (   )의 길', quizA:['지혜']
      },
    ];

    const STORAGE_KEY = 'bibleQuestProgress.v2'; // 진행/스탯
    const SETTINGS_KEY = 'bibleQuestSettings.v1';
    const LEADER_KEY   = 'bibleQuestLeaderboard.v1';

    // --- SETTINGS ---
    const settings = { sound:false, showStats:false, nickname:'게스트' };
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (raw){
          const o = JSON.parse(raw);
          if (typeof o.sound==='boolean') settings.sound = o.sound;
          if (typeof o.showStats==='boolean') settings.showStats = o.showStats;
          if (typeof o.showXP==='boolean' && typeof o.showStats!=='boolean') settings.showStats = o.showXP; // 구버전 호환
          if (typeof o.nickname==='string' && o.nickname.trim()) settings.nickname = o.nickname.trim();
        }
      }catch(e){}
    }
    function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

    // --- STATE (진행) ---
    const state = { cleared:new Set(), exp:0, hp:0, mp:0 };
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw){
          const o = JSON.parse(raw);
          state.cleared = new Set(o.cleared||[]);
          state.exp = Number(o.exp||0);
          state.hp = Number(o.hp||0);
          state.mp = Number(o.mp||0);
          return;
        }
      }catch(e){}
      try{
        const oldRaw = localStorage.getItem('bibleQuestProgress.v1');
        if (oldRaw){
          const o = JSON.parse(oldRaw);
          state.cleared = new Set(o.cleared||[]);
          state.exp = Number(o.exp||0);
          state.hp = Number(o.hp||0);
          state.mp = Number(o.mp||0);
          saveState();
        }
      }catch(e){}
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        cleared:[...state.cleared], exp:state.exp, hp:state.hp, mp:state.mp
      }));
    }

    // --- DOM 캐시 ---
    const introScreen = document.getElementById('introScreen');
    const mapScreen = document.getElementById('mapScreen');
    const stageList = document.getElementById('stageList');

    const hpFill = document.getElementById('hpFill'), mpFill = document.getElementById('mpFill'), xpFill = document.getElementById('xpFill');
    const hpLabel = document.getElementById('hpLabel'), mpLabel = document.getElementById('mpLabel'), xpLabel = document.getElementById('xpLabel');

    const questPanel = document.getElementById('questPanel'), qpTitle = document.getElementById('qpTitle'), qpSub = document.getElementById('qpSub');
    const qpRange = document.getElementById('qpRange'), qpReward = document.getElementById('qpReward'), qpReadLink = document.getElementById('qpReadLink');
    const markDoneBtn = document.getElementById('markDoneBtn'), closePanelBtn = document.getElementById('closePanelBtn');

    const overlay = document.getElementById('overlay'), toast = document.getElementById('toast');

    const soundToggle = document.getElementById('soundToggle'); const soundLabel = document.getElementById('soundLabel');

    const quizBox = document.getElementById('quizBox'), quizQuestion = document.getElementById('quizQuestion');
    const quizInput = document.getElementById('quizInput'), submitQuiz = document.getElementById('submitQuiz'), cancelQuiz = document.getElementById('cancelQuiz');

    const startBtn = document.getElementById('startBtn'), resetBtn = document.getElementById('resetBtn');
    const actionBtns = document.getElementById('actionBtns');

    const metersEl = document.querySelector('.meters'); const statsToggleBtn = document.getElementById('statsToggleBtn');

    const nameBtn = document.getElementById('nameBtn'); const nameLabel = document.getElementById('nameLabel');
    const boardBtn = document.getElementById('boardBtn'); const boardPanel = document.getElementById('boardPanel');
    const boardList = document.getElementById('boardList'); const closeBoardBtn = document.getElementById('closeBoardBtn');

    // 힌트
    const hintModal = document.getElementById('hintModal');
    const hintText  = document.getElementById('hintText');
    const readAgainBtn = document.getElementById('readAgainBtn');
    const closeHintBtn = document.getElementById('closeHintBtn');

    // --- AUDIO ---
    let audioCtx = null;
    function ensureAudio(){ if (!settings.sound) return; if (!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
    function sfx(type='click'){
      if (!settings.sound || !audioCtx) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
      let f=440, dur=.08; if (type==='success'){f=660; dur=.12} if (type==='error'){f=180; dur=.18} if (type==='click'){f=520; dur=.05}
      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.2, now+.01); g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.frequency.value=f; o.start(now); o.stop(now+dur);
    }

    // --- TOAST & CONFETTI ---
    function showToast(text, ms=1200){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), ms); }
    function confettiBurst(){
      const colors=['#ffd66e','#79a6ff','#86efac','#fca5a5','#a78bfa','#f9a8d4'];
      for (let i=0;i<24;i++){
        const el=document.createElement('div'); el.className='confetti-piece';
        const ang=(Math.random()*2-1)*Math.PI, dist=80+Math.random()*120;
        const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist-40;
        el.style.setProperty('--dx',`calc(-50% + ${dx}px)`); el.style.setProperty('--dy',`calc(-50% + ${dy}px)`); el.style.setProperty('--rot',`${(Math.random()*720-360)}deg`);
        el.style.background=colors[i%colors.length]; document.body.appendChild(el); setTimeout(()=>el.remove(),800);
      }
    }
    function showVictory(expText){ confettiBurst(); showToast(`🎉 VICTORY! ${expText}`); sfx('success'); if (navigator.vibrate) navigator.vibrate(50); }

    // --- PREF ---
    if (soundToggle) soundToggle.addEventListener('click', ()=>{
      settings.sound = !settings.sound;
      if (settings.sound){ ensureAudio(); sfx('success'); soundLabel.textContent='ON'; }
      else { sfx('click'); soundLabel.textContent='OFF'; }
      saveSettings();
    });

    // --- NAV ---
    if (startBtn) startBtn.addEventListener('click',(e)=>{ e.preventDefault(); showMap(); ensureAudio(); sfx('click'); });
    if (resetBtn) resetBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      if (confirm('진행 상황을 초기화할까요?')){
        state.cleared=new Set(); state.exp=state.hp=state.mp=0;
        saveState(); renderAll(); upsertMyScore(); showToast('초기화 완료!');
      }
    });
    if (closePanelBtn) closePanelBtn.addEventListener('click',()=>{ sfx('click'); closeQuest(); });
    overlay.addEventListener('click',()=>{ sfx('click'); closeQuest(); closeBoard(); closeHint(); });

    function showIntro(){ introScreen.style.display='block'; introScreen.setAttribute('aria-hidden','false'); mapScreen.style.display='none'; mapScreen.setAttribute('aria-hidden','true'); }
    function showMap(){ introScreen.style.display='none'; introScreen.setAttribute('aria-hidden','true'); mapScreen.style.display='block'; mapScreen.setAttribute('aria-hidden','false'); window.scrollTo({top:0, behavior:'smooth'}); }

    // --- 스탯 ---
    function renderMeters(){
      const totalHP=700, totalMP=700, totalXP=STAGES.reduce((s,st)=>s+st.exp,0);
      const c=state.cleared.size;
      state.hp=Math.min(totalHP, c*100); state.mp=Math.min(totalMP, c*100);
      hpFill.style.width=`${(state.hp/totalHP)*100}%`; mpFill.style.width=`${(state.mp/totalMP)*100}%`; xpFill.style.width=`${(state.exp/totalXP)*100}%`;
      hpLabel.textContent=`HP ${state.hp}/${totalHP}`; mpLabel.textContent=`MP ${state.mp}/${totalMP}`; xpLabel.textContent=`EXP ${state.exp}/${totalXP}`;
    }

    // --- 요일 잠금 ---
    const params=new URLSearchParams(location.search);
    const FREEPLAY = params.get('freeplay')==='1';
    function getTodayIndex(){ const d=new Date().getDay(); return d===0?6:d-1; } // 월=0..일=6
    function isUnlocked(i){ return FREEPLAY || i<=getTodayIndex(); }

    // --- 스테이지 렌더 ---
    function renderStages(){
      stageList.innerHTML='';
      const todayIndex=getTodayIndex();

      STAGES.forEach((st,idx)=>{
        const unlocked=isUnlocked(idx);
        const row=document.createElement('div'); row.className='stage panel pixel';
        if (idx===todayIndex) row.classList.add('today');
        if (!unlocked) row.classList.add('locked');
        if (state.cleared.has(st.id)) row.classList.add('cleared');

        if (idx===todayIndex){
          const badge=document.createElement('div');
          badge.className='today-badge';
          badge.textContent='오늘';
          row.append(badge);
        }

        const node=Object.assign(document.createElement('div'),{className:'node',textContent:st.dayKo});
        const info=document.createElement('div'); info.className='info';
        const lockLabel=!unlocked?' · 🔒 잠김':(state.cleared.has(st.id)?' · ✔️ 클리어됨':'');
        info.innerHTML=`
          <div class="day">Stage ${st.id} · ${st.dayKo}요일</div>
          <div class="text">${st.range}</div>
          <div class="reward">🏆 보상: +${st.exp} EXP <span class="clear">${lockLabel}</span></div>
        `;

        const go=document.createElement('button');
        go.className='go'+(unlocked?'':' lock') + (idx===todayIndex?' primary':'');
        go.textContent=unlocked?(idx===todayIndex?'🚀 오늘 시작':'자세히'):'🔒 잠김';
        if (!unlocked){ go.disabled=true; go.title='해당 요일에 열립니다'; }
        go.addEventListener('click',()=>{
          if (!unlocked){ showToast('🔒 아직 열리지 않았어요! 해당 요일에 도전해요'); sfx('error'); if (navigator.vibrate) navigator.vibrate(30); return; }
          sfx('click'); openQuest(st);
        });

        row.append(node,info,go);
        stageList.appendChild(row);
      });
    }

    // --- 퀴즈(다중 + 오답 3회 힌트) ---
    function getQuizzes(stage){
      if (Array.isArray(stage.quizzes) && stage.quizzes.length) return stage.quizzes;
      const obj = { q: stage.quizQ || '오늘 본문에서 핵심 단어를 맞혀보세요!', a: Array.isArray(stage.quizA) ? stage.quizA : [stage.quizA] };
      if (stage.hint) obj.h = stage.hint;
      return [obj];
    }

    function openQuest(stage){
      qpTitle.textContent=`MAIN QUEST · ${stage.title}`;
      qpSub.textContent='오늘의 본문을 읽고 완료로 표시해요!';
      qpRange.textContent=stage.range;
      qpReward.textContent=`+${stage.exp} EXP`;
      qpReadLink.href=stage.readLink||'#';

      const quizzes=getQuizzes(stage);
      let qIndex=0;
      let wrongStreak=0;

      function autoHintFromAnswer(ans){
        if (!ans) return '본문을 다시 읽고 핵심 단어를 찾아보세요!';
        const first = String(ans).trim();
        const firstChar = first[0] || '';
        return `정답은 ${first.length}글자, 첫 글자는 “${firstChar}” 입니다.`;
      }

      function renderQuiz(){
        wrongStreak=0; // 새 문제 시작 시 리셋
        quizQuestion.textContent=`문제 ${qIndex+1}/${quizzes.length} · ${quizzes[qIndex].q}`;
        quizInput.value=''; quizInput.classList.remove('shake','danger');
      }

      function showHint(){
        const cur = quizzes[qIndex];
        const firstAccept = Array.isArray(cur.a) ? cur.a.find(Boolean) : cur.a;
        const hint = cur.h || autoHintFromAnswer(firstAccept);
        hintText.textContent = hint;
        readAgainBtn.href = stage.readLink || '#';
        overlay.classList.add('active','front'); // 더 어둡게
        hintModal.classList.remove('hidden');
        setTimeout(()=>hintModal.classList.add('show'),10);
      }

      quizBox.classList.add('hidden');
      actionBtns.classList.remove('hidden');

      markDoneBtn.textContent='🧩 퀴즈 풀고 완료';
      markDoneBtn.onclick=()=>{ quizBox.classList.remove('hidden'); actionBtns.classList.add('hidden'); renderQuiz(); setTimeout(()=>quizInput.focus(),0); sfx('click'); };

      submitQuiz.onclick=()=>{
        const ans=(quizInput.value||'').trim().toLowerCase();
        const accepts=Array.isArray(quizzes[qIndex].a)?quizzes[qIndex].a:[quizzes[qIndex].a];
        const ok=accepts.filter(Boolean).map(s=>String(s).trim().toLowerCase()).includes(ans);

        if (ok){
          if (qIndex<quizzes.length-1){ qIndex++; sfx('success'); renderQuiz(); }
          else{
            if (!state.cleared.has(stage.id)){ state.cleared.add(stage.id); state.exp+=stage.exp; saveState(); renderAll(); }
            showVictory(`+${stage.exp} EXP`); actionBtns.classList.remove('hidden'); closeQuest(); upsertMyScore();
            // 가챠 기능 제거됨: 추가 동작 없음
          }
        }else{
          wrongStreak++;
          quizInput.classList.add('shake','danger'); setTimeout(()=>quizInput.classList.remove('shake','danger'),600);
          if (navigator.vibrate) navigator.vibrate([40,40]); sfx('error');

          if (wrongStreak>=3){
            wrongStreak=0; // 한 번 띄운 뒤 다시 누적
            showHint();     // 중앙 힌트 모달
          }else{
            showToast('앗! 다시 시도해봐요');
          }
        }
      };

      // 힌트 모달 버튼
      closeHintBtn.onclick = ()=>{ sfx('click'); closeHint(); setTimeout(()=>quizInput.focus(),50); };
      readAgainBtn.addEventListener('click', ()=>sfx('click'));

      cancelQuiz.onclick=()=>{ quizBox.classList.add('hidden'); actionBtns.classList.remove('hidden'); sfx('click'); };

      questPanel.classList.add('open'); questPanel.setAttribute('aria-hidden','false');
      document.body.classList.add('lock'); overlay.classList.add('active');
    }

    function closeQuest(){
      questPanel.classList.remove('open'); questPanel.setAttribute('aria-hidden','true');
      quizBox.classList.add('hidden'); actionBtns.classList.remove('hidden');
      if (!boardPanel.classList.contains('open') && !hintModal.classList.contains('show')) {
        overlay.classList.remove('active'); document.body.classList.remove('lock');
      }
    }

    function renderAll(){ renderStages(); renderMeters(); }

    // --- 스탯 토글 ---
    function applyStatsVisibility(){
      const open=settings.showStats;
      metersEl.classList.toggle('collapsed', !open);
      statsToggleBtn.textContent=open?'📊 스탯 숨기기':'📊 내 스탯 보기';
      statsToggleBtn.setAttribute('aria-expanded', String(open));
    }
    statsToggleBtn.addEventListener('click',()=>{ settings.showStats=!settings.showStats; applyStatsVisibility(); saveSettings(); });

    // --- 닉네임 & 리더보드 ---
    function applyNameUI(){ nameLabel.textContent=settings.nickname||'게스트'; }
    nameBtn.addEventListener('click',()=>{
      const next=prompt('닉네임을 입력하세요 (1–12자)', settings.nickname||'');
      if (next==null) return;
      const clean=String(next).trim().slice(0,12);
      if (!clean) return alert('닉네임은 1자 이상이어야 해요!');
      settings.nickname=clean; saveSettings(); applyNameUI(); upsertMyScore(); showToast('닉네임이 업데이트 되었어요!');
    });

    function loadLeaderboard(){ try{return JSON.parse(localStorage.getItem(LEADER_KEY))||[]}catch(e){return[]} }
    function saveLeaderboard(a){ localStorage.setItem(LEADER_KEY, JSON.stringify(a)); }
    function ensureLeaderboardSeed(){
      let a=loadLeaderboard();
      if (a.length===0){
        a=[
          {name:'믿음의 용사',exp:480,updatedAt:Date.now()-86400000*3},
          {name:'찬양러버',exp:420,updatedAt:Date.now()-86400000*2},
          {name:'기도장인',exp:360,updatedAt:Date.now()-86400000*5},
          {name:'지혜수집가',exp:300,updatedAt:Date.now()-86400000*4},
        ];
        saveLeaderboard(a);
      }
    }
    function upsertMyScore(){
      const me=settings.nickname||'게스트';
      let a=loadLeaderboard();
      const i=a.findIndex(r=>r.name===me);
      if (i>=0){ if (state.exp>(a[i].exp||0)) a[i].exp=state.exp; a[i].updatedAt=Date.now(); }
      else { a.push({name:me, exp:state.exp, updatedAt:Date.now()}); }
      saveLeaderboard(a);
    }
    function openBoard(){
      const me=settings.nickname||'게스트';
      const arr=loadLeaderboard().sort((x,y)=>(y.exp||0)-(x.exp||0)).slice(0,10);
      const trophy=i=>i===0?'🥇':i===1?'🥈':i===2?'🥉':'';
      const esc=s=>String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
      boardList.innerHTML=arr.map((r,i)=>`${trophy(i)} <strong>${esc(r.name)}</strong> — ${r.exp||0} EXP${r.name===me?' ★':''}`).map(li=>`<li>${li}</li>`).join('');
      boardPanel.classList.add('open'); boardPanel.setAttribute('aria-hidden','false');
      overlay.classList.add('active'); document.body.classList.add('lock');
    }
    function closeBoard(){
      boardPanel.classList.remove('open'); boardPanel.setAttribute('aria-hidden','true');
      if (!questPanel.classList.contains('open') && !hintModal.classList.contains('show')) {
        overlay.classList.remove('active'); document.body.classList.remove('lock');
      }
    }
    document.getElementById('boardBtn').addEventListener('click',()=>{ sfx('click'); openBoard(); });
    document.getElementById('closeBoardBtn').addEventListener('click',()=>{ sfx('click'); closeBoard(); });

    // --- 힌트 닫기 (ESC/오버레이) ---
    function closeHint(){
      hintModal.classList.remove('show');
      overlay.classList.remove('front'); // 진하게 올린거 해제
      setTimeout(()=>hintModal.classList.add('hidden'),150);
    }

    // --- INIT ---
    loadSettings(); loadState();
    renderAll(); showIntro();
    applyStatsVisibility(); applyNameUI(); ensureLeaderboardSeed(); upsertMyScore();
    window.addEventListener('click', ensureAudio, { once:true });
    window.addEventListener('keydown', (e)=>{
      if (e.key==='Escape'){
        closeQuest(); closeBoard(); closeHint();
      }
    });
    soundLabel.textContent = settings.sound ? 'ON' : 'OFF';
  });
  </script>
</body>
</html>
