<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bible Quest Â· Mobile</title>
  <link href="https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0f1a; --bg-soft:#0f1526; --panel:#121a2f;
      --ink:#f5f7ff; --ink-dim:#c8d0ff; --accent:#79a6ff; --accent-2:#ffd66e;
      --ok:#86efac; --warn:#fca5a5; --pixel:4px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 50% -200px, #1a2547 0%, var(--bg) 50%, #060911 100%);
      color:var(--ink);
      font-family:"Galmuri11",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Helvetica,Arial,sans-serif;
      letter-spacing:.2px;
    }
    body.lock{overflow:hidden; overscroll-behavior:contain}
    .wrap{max-width:480px; margin:0 auto; padding:12px}

    .hud{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg, rgba(10,14,27,.85), rgba(10,14,27,.35));
      backdrop-filter:blur(6px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }

    .panel{
      background:var(--panel);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      margin-top:1rem;
    }

    .cta{
      display:inline-flex; align-items:center; gap:8px;
      padding:12px 16px; font-weight:700; text-transform:uppercase;
      border:2px solid var(--ink);
      background:linear-gradient(180deg,#1f2c55,#152041);
      border-radius:12px; cursor:pointer; text-decoration:none; color:var(--ink);
    }
    .cta:active{transform:translateY(1px)}
    .cta.blink{animation:blink 1s step-end infinite}
    @keyframes blink{50%{opacity:.45}}

    .pixel{ position:relative; border:var(--pixel) solid #2a3c73; box-shadow:0 0 0 calc(var(--pixel)*2) #18234a,0 0 0 calc(var(--pixel)*3) #0e1633; border-radius:10px }

    #introScreen{ display:grid; place-items:center; min-height:77.5dvh; text-align:center; gap:18px }
    .title{ font-size:28px; line-height:1.1; letter-spacing:.5px; text-shadow:0 2px 0 #08102a,0 4px 14px rgba(121,166,255,.55) }
    .subtitle{ color:var(--ink-dim); font-size:12px; opacity:.9 }

    /* ìŠ¤íƒ¯ ì˜ì—­ */
    .meters{ display:grid; grid-template-columns:1fr; gap:20px; padding:10px 12px; overflow:hidden; max-height:500px; transition:max-height .38s ease, padding .38s ease, opacity .25s ease, transform .38s ease }
    .meters.collapsed{ max-height:0; padding-top:0; padding-bottom:0; opacity:0; transform:translateY(-8px); pointer-events:none }
    .bar{ background:#0c1327; border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:hidden; height:22px; position:relative }
    .bar>.fill{ height:100%; width:0%; transition:width .45s ease; background:linear-gradient(90deg,#4f7cff,#6fa8ff 60%,#a4c6ff); box-shadow: inset 0 0 12px rgba(121,166,255,.65) }
    .bar.hp>.fill{ background:linear-gradient(90deg,#2ed47a,#54ef9b 60%,#9bf4c4) }
    .bar.mp>.fill{ background:linear-gradient(90deg,#a78bfa,#c4b5fd 60%,#e9d5ff) }
    .bar .label{ position:absolute; inset:0; display:grid; place-items:center; font-size:10px; color:#e9edff; text-shadow:0 1px 0 #000; line-height:1 }

    #mapScreen{ display:none }
    .map{ display:grid; gap:12px; margin:16px 0 }

    .stage{
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
      padding:12px; background:var(--bg-soft);
      border:1px dashed rgba(255,255,255,.18); border-radius:12px; position:relative;
    }
    /* ì˜¤ëŠ˜ ê°•ì¡° */
    .stage.today{
      border: 1px solid rgba(255,214,110,.95);
      box-shadow:
        0 0 0 2px rgba(255,214,110,.28) inset,
        0 0 34px rgba(255,214,110,.45),
        0 0 2px rgba(255,214,110,.9) inset;
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(255,214,110,.1), transparent 42%),
        var(--bg-soft);
      animation: todayGlow 2.2s ease-in-out infinite;
    }
    @keyframes todayGlow{
      0%,100%{ box-shadow:0 0 0 2px rgba(255,214,110,.28) inset, 0 0 24px rgba(255,214,110,.35), 0 0 2px rgba(255,214,110,.9) inset }
      50%{ box-shadow:0 0 0 2px rgba(255,214,110,.32) inset, 0 0 44px rgba(255,214,110,.55), 0 0 2px rgba(255,214,110,1) inset }
    }
    .today-badge{
      position:absolute; top:-8px; right:8px;
      background:var(--accent-2); color:#111; font-weight:900; font-size:11px;
      padding:3px 8px; border-radius:999px; box-shadow:0 2px 10px rgba(255,214,110,.35);
    }
    .stage.locked{opacity:.85}
    .stage .node{ position:relative; width:34px; height:34px; border-radius:50%; display:grid; place-items:center; background:#1f2a4b; border:2px solid #92abff; font-weight:800 }
    .stage.today .node{ transform:scale(1.12); border-color:#ffd66e; box-shadow:0 0 12px rgba(255,214,110,.55); background: radial-gradient(80% 80% at 30% 20%, rgba(255,214,110,.45), #1f2a4b 55%) }
    .stage.today .node::after{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      box-shadow:0 0 0 0 rgba(255,214,110,.55);
      animation:pulseRing 1.6s ease-out infinite;
    }
    @keyframes pulseRing{
      0%{ box-shadow:0 0 0 0 rgba(255,214,110,.55) }
      100%{ box-shadow:0 0 0 14px rgba(255,214,110,0) }
    }
    .stage .info{display:grid; gap:2px}
    .stage .info .day{font-size:12px; color:var(--ink-dim)}
    .stage .info .text{font-size:14px}
    .stage .reward{font-size:11px; color:#cfe0ff; opacity:.85}
    .stage .clear{font-size:11px; color:var(--ok); display:none}
    .stage.cleared .clear{display:inline}
    .go{ padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg,#22305d,#17254a); color:var(--ink); font-weight:800; cursor:pointer }
    .stage.today .go{ outline:2px solid rgba(255,214,110,.65) }
    .go.primary{ background:linear-gradient(180deg,#ffd66e,#f2c655); color:#1a1410; border-color:rgba(0,0,0,.1); box-shadow:0 6px 18px rgba(255,214,110,.25); animation:bump 1.4s ease-in-out infinite }
    @keyframes bump { 0%,100%{ transform:translateY(0)} 50%{ transform:translateY(-1px)} }
    .go.lock{ opacity:.5; cursor:not-allowed; filter:grayscale(40%) }

    .prefs{ display:flex; gap:8px; flex-wrap:wrap; padding:0 12px 8px }
    .pref-btn{ cursor:pointer; user-select:none }

    #overlay{ position:fixed; inset:0; background:rgba(0,0,0,.8); opacity:0; pointer-events:none; transition:opacity .3s ease; z-index:40; backdrop-filter:blur(2px) }
    #overlay.active{ opacity:1; pointer-events:auto }
    #overlay.front{ z-index:58; background: rgba(0,0,0,.86); backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }

    /* ë°”í…€ì‹œíŠ¸ ê³µí†µ */
    #questPanel, #boardPanel, #rewardPanel{
      position:fixed; inset:auto 0 0 0; transform:translateY(105%);
      transition:transform .35s ease; background:#0b1228;
      border-top:1px solid rgba(255,255,255,.1); box-shadow:0 -10px 30px rgba(0,0,0,.55); z-index:50;
    }
    #questPanel.open, #boardPanel.open, #rewardPanel.open{ transform:translateY(0%) }

    #questPanel .quest-body{ max-height:78dvh; overflow:auto }
    #boardPanel .quest-body{ max-height:78dvh; overflow:auto }
    #rewardPanel .quest-body{ max-height:78dvh; overflow:auto }

    .quest-body{ padding:16px; display:grid; gap:12px }
    .quest-title{ font-size:18px; font-weight:900 }
    .quest-sub{ color:var(--ink-dim); font-size:12px }
    .quest-grid{ display:grid; gap:10px }
    .q-row{ display:grid; gap:6px }

    .chip{ display:inline-flex; gap:6px; align-items:center; padding:8px 10px; background:#131c38; border:1px solid rgba(255,255,255,.12); border-radius:999px; font-size:12px; color:var(--ink) }

    .btns{ display:grid; grid-template-columns:1fr 1fr; gap:8px }
    .btn{ padding:12px; border-radius:12px; font-weight:800; text-align:center; cursor:pointer; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg,#1f2c55,#152041); color:var(--ink) }
    .btn.warn{ background:linear-gradient(180deg,#3a1c22,#2a1116); border-color:rgba(255,99,99,.35); color:#ffb1b1 }
    .btn.ok{ background:linear-gradient(180deg,#1f3a2a,#152a1e); border-color:rgba(134,239,172,.35); color:#caffe1 }

    #toast{ position:fixed; left:50%; bottom:92px; transform:translateX(-50%) translateY(20px); background:rgba(20,28,56,.9); color:#fff; padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.1); opacity:0; pointer-events:none; transition:opacity .25s ease, transform .25s ease; z-index:60 }
    #toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

    .confetti-piece{ position:fixed; top:50%; left:50%; width:6px; height:12px; transform-origin:center; pointer-events:none; z-index:60; opacity:0; animation:confetti-pop 700ms ease-out forwards }
    @keyframes confetti-pop{ 0%{opacity:0; transform:translate(-50%,-50%) rotate(0deg) scale(.8)} 100%{opacity:1; transform:translate(var(--dx),var(--dy)) rotate(var(--rot)) scale(1)} }
    .shake{ animation:shakeX .35s ease }
    @keyframes shakeX{ 0%,100%{transform:translateX(0)} 20%{transform:translateX(-6px)} 40%{transform:translateX(6px)} 60%{transform:translateX(-4px)} 80%{transform:translateX(4px)} }

    .hidden{ display:none!important }
    @supports(padding:max(0px)){ #questPanel,#boardPanel,#rewardPanel{ padding-bottom:max(14px, env(safe-area-inset-bottom)) } }

    .link,.link:link,.link:visited{ color:var(--accent-2); text-decoration:none; font-weight:800 }
    .link:hover{ text-decoration:underline; text-underline-offset:2px }

    .topbar{ display:flex; align-items:center; gap:8px; padding:12px }
    .topbar .meta{ flex:1; min-width:0 }
    #resetBtn{ margin-left:auto; white-space:nowrap }

    .hud-ctrl{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; padding:8px 0 4px }

    /* íŒíŠ¸ ëª¨ë‹¬ */
    .hint-modal{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%) scale(.96);
      width: min(92vw, 420px);
      background:#0b1228; border:1px solid rgba(255,255,255,.12);
      box-shadow:0 14px 36px rgba(0,0,0,.55);
      border-radius:14px; z-index:60; padding:16px;
      opacity:0; pointer-events:none; transition:opacity .2s ease, transform .2s ease;
    }
    .hint-modal.show{ opacity:1; pointer-events:auto; transform:translate(-50%,-50%) scale(1) }
    .hint-title{ font-weight:900; margin-bottom:6px }
    .hint-text{ color:var(--ink-dim); font-size:13px; line-height:1.4 }
    .hint-btns{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px }

    /* ğŸ ì´ë¯¸ì§€ ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
    #rewardArt { display:grid; place-items:center; padding:18px }
    .reward-card {
      width: 100%;
      max-width: 320px;
      aspect-ratio: 16 / 11;           /* í•„ìš”ì‹œ 1/1, 4/5 ë“±ìœ¼ë¡œ ë³€ê²½ */
      border-radius: 12px;
      overflow: hidden;
      background: #0f1526;
      border: 1px solid rgba(255,255,255,.1);
      box-shadow: 0 8px 20px rgba(0,0,0,.35);
      position: relative;
    }
    .reward-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;               /* ì´ë¯¸ì§€ ê½‰ ì±„ìš°ê¸° */
      display: block;
    }
    .reward-tag {
      position: absolute; left: 8px; bottom: 8px;
      background: rgba(0,0,0,.45); color: #ffd66e;
      font-weight: 900; font-size: 12px; padding: 4px 8px; border-radius: 999px;
      border: 1px solid rgba(255,214,110,.35);
      backdrop-filter: blur(2px);
    }

    .reward-anim{ animation:wiggle .8s ease-in-out }
    @keyframes wiggle{
      0%,100%{ transform:scale(1) rotate(0deg) }
      25%{ transform:scale(1.02) rotate(-1deg) }
      50%{ transform:scale(1.02) rotate(1deg) }
      75%{ transform:scale(1.02) rotate(-.6deg) }
    }
  </style>
</head>
<body>
  <div class="hud">
    <div class="wrap">
      <div class="hud-ctrl">
        <button id="nameBtn" class="chip pref-btn">ğŸ™‹ ë‹‰ë„¤ì„: <strong id="nameLabel">ê²ŒìŠ¤íŠ¸</strong></button>
        <button id="boardBtn" class="chip pref-btn">ğŸ† ë¦¬ë”ë³´ë“œ</button>
        <button id="statsToggleBtn" class="chip pref-btn">ğŸ“Š ë‚´ ìŠ¤íƒ¯ ë³´ê¸°</button>
      </div>
      <div class="meters">
        <div class="bar hp pixel" aria-label="ë¯¿ìŒ(HP)">
          <div class="fill" id="hpFill"></div>
          <div class="label"><span id="hpLabel">HP 0/700</span></div>
        </div>
        <div class="bar mp pixel" aria-label="ê¸°ë„ë ¥(MP)">
          <div class="fill" id="mpFill"></div>
          <div class="label"><span id="mpLabel">MP 0/700</span></div>
        </div>
        <div class="bar xp pixel" aria-label="ì§€í˜œ(EXP)">
          <div class="fill" id="xpFill"></div>
          <div class="label"><span id="xpLabel">EXP 0/0</span></div>
        </div>
      </div>
    </div>
  </div>

  <section id="introScreen" class="wrap">
    <div class="panel pixel" style="padding:28px 18px; margin-top: 5rem;">
      <div class="title">âœï¸ BIBLE QUEST</div>
      <div class="subtitle" style="margin-top: 15px; font-size: 15px;">ì‹œí¸ì—ì„œ ì ì–¸ìœ¼ë¡œ, í•œ ì£¼ê°„ì˜ ì§€í˜œ ì—¬ì •!</div>
      <div style="height:15px;"></div>
      <a id="startBtn" class="cta blink" href="#">PRESS START</a>
      <div style="height:15px"></div>
      <div class="subtitle" style="font-size: 10px;">ëª¨ë°”ì¼ ê¸°ì¤€ Â· iPhone SE ë„ˆë¹„ ìµœì í™”<br/>(ê¸°ê¸°ì— ë”°ë¼ ë¹„ìœ¨ì´ ì¡°ê¸ˆ í‹€ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤!)</div>
    </div>
    <div class="prefs" style="margin-top: 2rem;">
      <button id="soundToggle" class="chip pref-btn">ğŸ”Š ì‚¬ìš´ë“œ: <strong id="soundLabel" style="margin-left:6px;">OFF</strong></button>
    </div>
  </section>

  <section id="mapScreen" class="wrap">
    <div class="topbar">
      <div class="meta">
        <div style="font-weight:900;font-size:14px">ğŸ—ºï¸ ìŠ¤í…Œì´ì§€ ë§µ (ì›”â†’ì¼)</div>
      </div>
      <a id="resetBtn" class="link" href="#">ì§„í–‰ ì´ˆê¸°í™”</a>
    </div>
    <div id="stageList" class="map"></div>
  </section>

  <div id="overlay"></div>
  <div id="toast"></div>

  <!-- íŒíŠ¸ ëª¨ë‹¬ (ì˜¤ë‹µ 3íšŒ ì´ìƒ) -->
  <div id="hintModal" class="hint-modal hidden">
    <div class="hint-title">ğŸ’¡ íŒíŠ¸ê°€ ë„ì°©í–ˆì–´ìš”</div>
    <div id="hintText" class="hint-text">ì •ë‹µì„ ë‹¤ì‹œ ìƒê°í•´ë³¼ê¹Œìš”?</div>
    <div class="hint-btns">
      <a id="readAgainBtn" class="btn" target="_blank" rel="noopener">ë³¸ë¬¸ ë‹¤ì‹œ ì½ê¸°</a>
      <button id="closeHintBtn" class="btn ok">ê³„ì† í’€ê¸°</button>
    </div>
  </div>

  <!-- í€˜ìŠ¤íŠ¸ íŒ¨ë„ -->
  <aside id="questPanel" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="quest-body wrap">
      <div class="quest-title" id="qpTitle">MAIN QUEST</div>
      <div class="quest-sub" id="qpSub">ì˜¤ëŠ˜ì˜ ë³¸ë¬¸ì„ ì½ê³  ì™„ë£Œë¡œ í‘œì‹œí•´ìš”!</div>

      <div class="quest-grid">
        <div class="q-row">
          <div class="chip">ğŸ“– <span id="qpRange">ì‹œí¸ 132â€“134í¸</span></div>
          <div class="chip">ğŸ† ë³´ìƒ: <span id="qpReward">+100 EXP</span></div>
        </div>
        <div class="q-row"><a id="qpReadLink" class="cta" target="_blank" rel="noopener">ë³¸ë¬¸ ì½ê¸° ì—´ê¸°</a></div>
      </div>

      <div id="quizBox" class="panel pixel hidden" style="margin-top:10px;">
        <div style="font-weight:900;margin-bottom:6px;">ğŸ§© ë‹¨ì–´ í€´ì¦ˆ</div>
        <div id="quizQuestion" class="subtitle" style="margin-bottom:10px;">ì˜¤ëŠ˜ ë³¸ë¬¸ì—ì„œ í•µì‹¬ ë‹¨ì–´ë¥¼ ë§í˜€ë³´ì„¸ìš”!</div>
        <input id="quizInput" type="text" placeholder="ì •ë‹µ ë‹¨ì–´ ì…ë ¥"
          style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:#0c1327;color:#e9edff;font-family:inherit;">
        <div class="small" style="margin-top:6px;color:#c8d0ff;">ì •í™•í•œ ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì•¼ í†µê³¼!</div>
        <div class="btns" style="margin-top:10px;">
          <button id="submitQuiz" class="btn ok">ì •ë‹µ ì œì¶œ</button>
          <button id="cancelQuiz" class="btn">ì·¨ì†Œ</button>
        </div>
      </div>

      <div id="actionBtns" class="btns" style="margin-top:10px;">
        <button id="markDoneBtn" class="btn ok">ğŸ§© í€´ì¦ˆ í’€ê³  ì™„ë£Œ</button>
        <button id="closePanelBtn" class="btn">ë‹«ê¸°</button>
      </div>
    </div>
  </aside>

  <!-- ë¦¬ë”ë³´ë“œ íŒ¨ë„ -->
  <aside id="boardPanel" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="quest-body wrap">
      <div class="quest-title">ğŸ† ë¦¬ë”ë³´ë“œ</div>
      <div class="quest-sub">ìƒìœ„ 10ëª… Â· ë‚´ ê¸°ë¡ì€ â˜…ë¡œ í‘œì‹œë¼ìš”</div>
      <ol id="boardList" style="margin:6px 0 12px; padding-left:18px;"></ol>
      <div class="btns"><button id="closeBoardBtn" class="btn">ë‹«ê¸°</button></div>
    </div>
  </aside>

  <!-- ğŸ íŠ¹ë³„ ë³´ìƒ íŒ¨ë„ -->
  <aside id="rewardPanel" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="quest-body wrap">
      <div class="quest-title">ğŸ ì˜¤ëŠ˜ì˜ íŠ¹ë³„ ë³´ìƒ</div>
      <div class="quest-sub" id="rewardStatus">í€´ì¦ˆ í´ë¦¬ì–´ í›„ ë³´ìƒì„ ë°›ì•„ìš” Â· í•˜ë£¨ 1íšŒ</div>

      <div id="rewardArt" class="panel pixel"></div>
      <div id="rewardCaption" class="subtitle" style="text-align:center;"></div>

      <div class="btns">
        <button id="claimRewardBtn" class="btn ok">âœ¨ íŠ¹ë³„ ë³´ìƒ ë°›ê¸°</button>
        <button id="closeRewardBtn" class="btn">ë‹«ê¸°</button>
      </div>
    </div>
  </aside>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // --- DATA ---
    const STAGES = [
      { id:1, dayKo:'ì›”', title:'ì„±ì „ì— ì˜¬ë¼ ì°¬ì–‘í•˜ë¼', range:'ì‹œí¸ 132â€“134í¸', exp:100,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=132&sec=1',
        quizzes:[
          { q:'ì‹œí¸ 132â€“134í¸ í•µì‹¬ ë‹¨ì–´?', a:['ì‹œì˜¨','ì‹œì˜¨ì‚°'], h:'â€œìˆœë¡€ì˜ ë…¸ë˜â€ê°€ ê°€ë¦¬í‚¤ëŠ” ì¥ì†Œ ğŸ‘€ ì´ˆì„± (ã……ã…‡ / ã……ã…‡ã……)' },
          { q:'ì‹œí¸ 133í¸ì˜ ì£¼ì œ í•œ ë‹¨ì–´?', a:['ì—°í•©'], h:'ë³´ë¼ í˜•ì œê°€ (ã…‡ã…)í•˜ì—¬ ë™ê±°í•¨ì´ ì–´ì°Œ ê·¸ë¦¬ ì„ í•˜ê³ â€¦' }
        ]
      },
      { id:2, dayKo:'í™”', title:'ë°”ë²¨ë¡  ê°•ê°€ì˜ ë…¸ë˜', range:'ì‹œí¸ 135â€“137í¸', exp:150,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=135&sec=1',
        quizQ:'ì‹œí¸ 137í¸ì—ì„œ ì‹œì¸ë“¤ì´ ê·¸ë¦¬ì›Œí•œ ë„ì‹œëŠ”?', quizA:['ì˜ˆë£¨ì‚´ë ˜'], hint:'ê·¸ë¦¬ìš´ ã…‡ã„¹ã……ã„¹, ë”°ìŠ¤í•œ ì‹œì˜¨ì„± ìœ„ì—~'
      },
      { id:3, dayKo:'ìˆ˜', title:'ì£¼ê»˜ì„œ ë‚˜ë¥¼ ë³´í˜¸í•˜ì‹œë‹¤', range:'ì‹œí¸ 138â€“140í¸', exp:200,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=138&sec=1',
        quizQ:'ì‹œí¸ 139í¸ì˜ ì£¼ì œ: â€œì£¼ê»˜ì„œëŠ” ë‚´ ( ã……ã„± )ì„ ì•Œê³  ê³„ì‹­ë‹ˆë‹¤.â€ ë¹ˆì¹¸ì€?', quizA:['ìƒê°','ìƒê°ë“¤']
      },
      { id:4, dayKo:'ëª©', title:'ì‹œí—˜ì—ì„œ êµ¬í•˜ì†Œì„œ', range:'ì‹œí¸ 141â€“143í¸', exp:150,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=141&sec=1',
        quizQ:'ì‹œí¸ 143í¸ì—ì„œ ì‹œì¸ì€ ë¬´ì—‡ì—ì„œ ì¸ë„í•´ ë‹¬ë¼ê³  ê¸°ë„í• ê¹Œìš”? ( ã…ã„´ / ã„±ã„´ )', quizA:['í™˜ë‚œ','ê³ ë‚œ']
      },
      { id:5, dayKo:'ê¸ˆ', title:'í•˜ë‚˜ë‹˜ì€ ë‚˜ì˜ í”¼ë‚œì²˜', range:'ì‹œí¸ 144â€“146í¸', exp:200,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=144&sec=1',
        quizQ:'ì‹œí¸ 144â€“146í¸ì—ì„œ ë°˜ë³µë˜ëŠ” ê°íƒ„ì‚¬ëŠ”?', quizA:['í• ë ë£¨ì•¼']
      },
      { id:6, dayKo:'í† ', title:'ì§€í˜œì˜ ì„œë§‰', range:'ì‹œí¸ 147í¸ â€“ ì ì–¸ 1ì¥', exp:250,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=psa&chap=147&sec=1',
        quizQ:'ì ì–¸ 1ì¥ 7ì ˆ: ì§€ì‹ì˜ ê·¼ë³¸ì€ â€œì—¬í˜¸ì™€ë¥¼ ( ã„±ã…‡ )í•˜ëŠ” ê²ƒâ€. ë¹ˆì¹¸ì€?', quizA:['ê²½ì™¸']
      },
      { id:7, dayKo:'ì¼', title:'ì§€í˜œì˜ ê¸¸ì„ ì„ íƒí•˜ë¼', range:'ì ì–¸ 2â€“6ì¥', exp:250,
        readLink:'https://www.bskorea.or.kr/bible/korbibReadpage.php?version=GAE&book=pro&chap=2&sec=1',
        quizQ:'ì ì–¸ì—ì„œ ê°•ì¡°í•˜ëŠ” ê¸¸ì€? ( ã…ˆã… )ì˜ ê¸¸', quizA:['ì§€í˜œ']
      },
    ];

    /* ğŸ ì˜¤ëŠ˜ì˜ ë²„í”„ ì¹´ë“œ í’€ (ì´ë¯¸ì§€ ê²½ë¡œë§Œ ì‚¬ìš©) */
    // ê²½ë¡œëŠ” í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš” (ì˜ˆ: /assets/cards/*.png)
    const BUFF_POOL = [
      { id:'pastor_kds', name:'ê°•ë™ì„ ëª©ì‚¬ë‹˜',
        habit:'ì²­ë…„íšŒë¥¼ ì´ëŒì–´ì£¼ì‹œëŠ” ì´ˆìêµíšŒì˜ ì‹ í¥ê°•ì. ë§ˆì´í¬ë¥¼ ì¡ìœ¼ë©´ ì°¬ì–‘ì´ 1.5ë°° ì‹œì›í•´ì§„ë‹¤.',
        stat:'mp', pct:20, img:'./img/KDS.png' },

      { id:'osara', name:'ì˜¤ì‚¬ë¼',
        habit:'êµíšŒ ê³³ê³³ í•„ìš”í•œ ê³³ ì–´ë””ë“  ë²ˆê°œì²˜ëŸ¼ ë‚ ì•„ë‹¤ë‹Œë‹¤. ì—´ì • ê°€ë“ í–‰í•¨ìœ¼ë¡œ ì£¼ìœ„ ì‚¬ëŒë“¤ì—ê²Œ ë„ì „ê³¼ ìš©ê¸°ë¥¼ ì¤€ë‹¤.',
        stat:'exp', pct:12, img:'./img/OSR.png' },

      { id:'sunmin', name:'ì´ì„ ë¯¼',
        habit:'ì²­ë…„íšŒì˜ ê·€ì–Œë™ì´. í™œì´ ìŠ¤ì¹˜ë©´ ë§ˆìŒì´ ìë™ ë¹„ë¸Œë¼í†  ëª¨ë“œê°€ ëœë‹¤.',
        stat:'mp', pct:12, img:'./img/LSM.png' },

      { id:'yesung', name:'ì´ì˜ˆìŠ¹',
        habit:'ì–‘ ì†ì— ë¤ë²¨ ë“¤ê³  í†µì„±ê¸°ë„ë¡œ ê·¼ì†ì‹¤ì„ ë°©ì§€í•œë‹¤.(ì˜Â·ìœ¡ ëª¨ë‘ ë“ê·¼)',
        stat:'hp', pct:15, img:'./img/LYS.png' },

      { id:'onyu', name:'ê¹€ì˜¨ìœ ',
        habit:'ì´˜ì´˜í•œ ê³„íšìœ¼ë¡œ í–‰ì •êµ­ì˜ ê³„íšì„ íƒ„íƒ„í•˜ê²Œ ë•ëŠ”ë‹¤. í•¨ê¼í•˜ë©´ Jë ¥ ìƒìŠ¹!',
        stat:'exp', pct:8, img:'./img/KOU.png' },

      { id:'miji', name:'ê¹€ë¯¸ì§€',
        habit:'í¬ìŠ¤í„° í•˜ë‚˜ë©´ ì²­ë…„íšŒ ë¶„ìœ„ê¸° 120% ì—…! ì²­ë…„íšŒ ëª¨ë“  ë””ìì¸ì˜ ì£¼ì¶•!!',
        stat:'exp', pct:8, img:'./img/KMJ.png' },

      { id:'taehyun', name:'í•˜íƒœí˜„',
        habit:'í…Œë‹ˆìŠ¤ ì½”íŠ¸ ë°–(ì²­ë…„íšŒ)ì—ì„œë„ ì¬ë¹ ë¥¸ í’‹ì›Œí¬ë¡œ ê³µë™ì²´ë¥¼ í–¥í•œ ë§ˆìŒ ì´ˆìŠ¤í”¼ë“œ ì…‹íŒ….',
        stat:'hp', pct:10, img:'./img/HTH.png' },

      { id:'hyemin', name:'ê¹€í˜œë¯¼',
        habit:'ì´ˆì êµíšŒì˜ ìƒí¼ ë¹„íƒ€ë¯¼. ì´ˆìêµíšŒì˜ ê¶Œì€ë¹„. í•´ë§‘ì€ ë¯¸ì†Œë¡œ ëª¨ë“  ì‚¬ëŒì˜ MPë¥¼ ì±„ì›Œì¤€ë‹¤',
        stat:'mp', pct:10, img:'./img/KHM.png' },

      { id:'yudae', name:'ìœ ëŒ€ì˜ ë¶€ì¥ì§‘ì‚¬ë‹˜',
        habit:'ì²­ë…„íšŒì˜ ë“ ë“ í•œ ê¸°ë‘¥! ìˆ˜ë ¨íšŒ ë§ˆë‹¤ ì‹ì‚¬ ë´‰ì‚¬ë¡œ ëª¨ë‘ì˜ HPë¥¼ ë“ ë“ íˆ ì±„ìš´ë‹¤. (í™ê¶Œì‚¬ë‹˜ ì°¬ìŠ¤ ìë™ ë°œë™)',
        stat:'hp', pct:12, img:'./img/YDY.png' },

      { id:'baek', name:'ë°±ìš´íœ˜',
        habit:'ê°ë™ì ì¸ ë°©ì†¡íŒ€ ì§€íœ˜ì. ì£¼ë‹˜ì´ í•¨ê»˜í•˜ì‹œëŠ” ì¹´ë©”ë¼ ì›Œí¬! ê°ë™ìœ¼ë¡œ ì¤Œì¸!!',
        stat:'mp', pct:8, img:'./img/BUH.png' },

      { id:'kimji', name:'ê¹€ì •ì„',
        habit:'ì´ˆì êµíšŒì˜ ì‘ì€ í­êµ°. ì„ í¬í•˜ë©´ ë§ˆìŒì´ ìë™ìœ¼ë¡œ â€œì•„ë©˜!â€',
        stat:'exp', pct:12, img:'./img/KJI.png' },

      { id:'jiyoon', name:'ì´ì§€ìœ¤',
        habit:'ì²¼ë¡œ ì €ìŒì— ë§ˆìŒì´ ì”ì”â€”ê¸°ë„ ëª°ì… ê²Œì´ì§€ â†‘.',
        stat:'mp', pct:10, img:'./img/LGY.png' },

      { id:'haewon', name:'ê¹€í•´ì›',
        habit:'ì„ êµ ì§€ë„ë¥¼ í´ë©´ ì§€í˜œê°€ ê³³ê³³ì—ì„œ ì†ŸìŒ. ê·¸ë…€ê°€ í–¥í•˜ëŠ” ì—´ë°©ì—ì„œëŠ” ì˜ì  GPS ìë™ ì‹¤í–‰!',
        stat:'exp', pct:10, img:'./img/KHO.png' },

      { id:'yesle', name:'ì •ì˜ˆìŠ¬',
        habit:'ì‹ ë”” ê±´ë°˜ í•œ ë²ˆì— ì˜í˜¼ ì¶©ì „ 200%',
        stat:'mp', pct:15, img:'./img/JYS.png' },

      { id:'chaebin', name:'ë°•ì±„ë¹ˆ',
        habit:'"ì—? ì™œìš”?" ë¬´ê¶ë¬´ì§„í•œ í˜¸ê¸°ì‹¬ìœ¼ë¡œ ì–´ë–¤ ëª¨í—˜ë„ ë§ˆë‹¤í•˜ì§€ ì•ŠìŒ! ëœ»ë°–ì˜ ë³´ë¬¼ë“¤ì„ íšë“í•  í™•ë¥  up ',
        stat:'exp', pct:7, img:'./img/BCB.png' },

      { id:'hyosul', name:'ê°•íš¨ìŠ¬',
        habit:'ì•Œì˜ë”± ì¼ì²˜ë¦¬ ìˆœì‚­! â€œì–¸ë‹ˆ(ëˆ„ë‚˜) ë„ìš¸ ê±° ìˆì–´ìš”?â€ í•˜ë©´ ì´ë¯¸ ëë‚˜ìˆìŒ!',
        stat:'hp', pct:8, img:'./img/KHS.png' },

      { id:'hwayon', name:'ë„í™”ì—°',
        habit:'í•­ìƒ ì–´ë”˜ê°€ ì§€ì³ìˆìŒ. í•˜ì§€ë§Œ ë‹¤ë¥¸ ì§€ì²´ë“¤ì˜ ë§ˆìŒì€ ê·¸ë…€ì˜ ë”°ëœ»í•œ ê´€ì‹¬ìœ¼ë¡œ ì¸í•´ íë§ì¤‘! ë‹¬ì²˜ëŸ¼ ì”ì”í•˜ê²Œ íœ´ì‹ ëª¨ë“œë¥¼ ì¼œì¤€ë‹¤',
        stat:'hp', pct:8, img:'./img/DHY.png' },

      { id:'sunghoon', name:'ì¥ì„±í›ˆ',
        habit:'í–‡ì‚´ê°™ì€ ë”°ëœ»í•œ ë¯¸ì†Œì™€ ì–´ë””ë“  ë¹ ì§€ì§€ ì•ŠëŠ” ì—´ì •ì´ ë³´ëŠ” ì‚¬ëŒê¹Œì§€ ë”°ëœ»í•˜ê²Œ ë§Œë“¤ì–´ë²„ë¦°ë‹¤.',
        stat:'mp', pct:8, img:'./img/JSH.png' },
    ];

    const STORAGE_KEY = 'bibleQuestProgress.v2'; // ì§„í–‰/ìŠ¤íƒ¯
    const SETTINGS_KEY = 'bibleQuestSettings.v1';
    const LEADER_KEY   = 'bibleQuestLeaderboard.v1';
    const BUFF_KEY     = 'bibleQuestBuff.v1'; // { date:'YYYY-MM-DD', id:'...' }

    // --- SETTINGS ---
    const settings = { sound:false, showStats:false, nickname:'ê²ŒìŠ¤íŠ¸' };
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        if (raw){
          const o = JSON.parse(raw);
          if (typeof o.sound==='boolean') settings.sound = o.sound;
          if (typeof o.showStats==='boolean') settings.showStats = o.showStats;
          if (typeof o.showXP==='boolean' && typeof o.showStats!=='boolean') settings.showStats = o.showXP; // êµ¬ë²„ì „ í˜¸í™˜
          if (typeof o.nickname==='string' && o.nickname.trim()) settings.nickname = o.nickname.trim();
        }
      }catch(e){}
    }
    function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); }

    // --- STATE (ì§„í–‰) ---
    const state = { cleared:new Set(), exp:0, hp:0, mp:0 };
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw){
          const o = JSON.parse(raw);
          state.cleared = new Set(o.cleared||[]);
          state.exp = Number(o.exp||0);
          state.hp = Number(o.hp||0);
          state.mp = Number(o.mp||0);
          return;
        }
      }catch(e){}
      try{
        const oldRaw = localStorage.getItem('bibleQuestProgress.v1');
        if (oldRaw){
          const o = JSON.parse(oldRaw);
          state.cleared = new Set(o.cleared||[]);
          state.exp = Number(o.exp||0);
          state.hp = Number(o.hp||0);
          state.mp = Number(o.mp||0);
          saveState();
        }
      }catch(e){}
    }
    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        cleared:[...state.cleared], exp:state.exp, hp:state.hp, mp:state.mp
      }));
    }

    // --- ì˜¤ëŠ˜ ë²„í”„ ìƒíƒœ ---
    const buffState = { date:null, id:null };
    function loadBuff(){
      try{
        const raw = localStorage.getItem(BUFF_KEY);
        if (raw){
          const o = JSON.parse(raw);
          buffState.date = o.date || null;
          buffState.id   = o.id   || null;
        }
      }catch(e){}
    }
    function saveBuff(){
      localStorage.setItem(BUFF_KEY, JSON.stringify({
        date: buffState.date, id: buffState.id
      }));
    }
    const localYMD = (d=new Date())=>{
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    const hasBuffToday = ()=> buffState.date===localYMD();
    const activeBuff = ()=> hasBuffToday() ? BUFF_POOL.find(b=>b.id===buffState.id) : null;

    // --- DOM ìºì‹œ ---
    const introScreen = document.getElementById('introScreen');
    const mapScreen   = document.getElementById('mapScreen');
    const stageList   = document.getElementById('stageList');

    const hpFill = document.getElementById('hpFill'), mpFill = document.getElementById('mpFill'), xpFill = document.getElementById('xpFill');
    const hpLabel = document.getElementById('hpLabel'), mpLabel = document.getElementById('mpLabel'), xpLabel = document.getElementById('xpLabel');

    const questPanel = document.getElementById('questPanel'), qpTitle = document.getElementById('qpTitle'), qpSub = document.getElementById('qpSub');
    const qpRange = document.getElementById('qpRange'), qpReward = document.getElementById('qpReward'), qpReadLink = document.getElementById('qpReadLink');
    const markDoneBtn = document.getElementById('markDoneBtn'), closePanelBtn = document.getElementById('closePanelBtn');

    const overlay = document.getElementById('overlay'), toast = document.getElementById('toast');

    const soundToggle = document.getElementById('soundToggle'); const soundLabel = document.getElementById('soundLabel');

    const quizBox = document.getElementById('quizBox'), quizQuestion = document.getElementById('quizQuestion');
    const quizInput = document.getElementById('quizInput'), submitQuiz = document.getElementById('submitQuiz'), cancelQuiz = document.getElementById('cancelQuiz');

    const startBtn = document.getElementById('startBtn'), resetBtn = document.getElementById('resetBtn');
    const actionBtns = document.getElementById('actionBtns');

    const metersEl = document.querySelector('.meters'); const statsToggleBtn = document.getElementById('statsToggleBtn');

    const nameBtn = document.getElementById('nameBtn'); const nameLabel = document.getElementById('nameLabel');
    const boardBtn = document.getElementById('boardBtn'); const boardPanel = document.getElementById('boardPanel');
    const boardList = document.getElementById('boardList'); const closeBoardBtn = document.getElementById('closeBoardBtn');

    // ë³´ìƒ DOM
    const rewardPanel   = document.getElementById('rewardPanel');
    const rewardArt     = document.getElementById('rewardArt');
    const rewardCaption = document.getElementById('rewardCaption');
    const rewardStatus  = document.getElementById('rewardStatus');
    const claimRewardBtn= document.getElementById('claimRewardBtn');
    const closeRewardBtn= document.getElementById('closeRewardBtn');

    // íŒíŠ¸
    const hintModal = document.getElementById('hintModal');
    const hintText  = document.getElementById('hintText');
    const readAgainBtn = document.getElementById('readAgainBtn');
    const closeHintBtn = document.getElementById('closeHintBtn');

    // --- AUDIO ---
    let audioCtx = null;
    function ensureAudio(){ if (!settings.sound) return; if (!audioCtx){ try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} } }
    function sfx(type='click'){
      if (!settings.sound || !audioCtx) return;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination);
      let f=440, dur=.08; if (type==='success'){f=660; dur=.12} if (type==='error'){f=180; dur=.18} if (type==='click'){f=520; dur=.05}
      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now); g.gain.exponentialRampToValueAtTime(0.2, now+.01); g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.frequency.value=f; o.start(now); o.stop(now+dur);
    }

    // --- TOAST & CONFETTI ---
    function showToast(text, ms=1200){ toast.textContent=text; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), ms); }
    function confettiBurst(){
      const colors=['#ffd66e','#79a6ff','#86efac','#fca5a5','#a78bfa','#f9a8d4'];
      for (let i=0;i<24;i++){
        const el=document.createElement('div'); el.className='confetti-piece';
        const ang=(Math.random()*2-1)*Math.PI, dist=80+Math.random()*120;
        const dx=Math.cos(ang)*dist, dy=Math.sin(ang)*dist-40;
        el.style.setProperty('--dx',`calc(-50% + ${dx}px)`); 
        el.style.setProperty('--dy',`calc(-50% + ${dy}px)`); 
        el.style.setProperty('--rot',`${(Math.random()*720-360)}deg`);
        el.style.background=colors[i%colors.length]; document.body.appendChild(el); setTimeout(()=>el.remove(),800);
      }
    }
    function showVictory(expText){ confettiBurst(); showToast(`ğŸ‰ VICTORY! ${expText}`); sfx('success'); if (navigator.vibrate) navigator.vibrate(50); }

    // --- PREF ---
    if (soundToggle) soundToggle.addEventListener('click', ()=>{
      settings.sound = !settings.sound;
      if (settings.sound){ ensureAudio(); sfx('success'); soundLabel.textContent='ON'; }
      else { sfx('click'); soundLabel.textContent='OFF'; }
      saveSettings();
    });

    // --- NAV ---
    if (startBtn) startBtn.addEventListener('click',(e)=>{ e.preventDefault(); showMap(); ensureAudio(); sfx('click'); });
    if (resetBtn) resetBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      if (confirm('ì§„í–‰ ìƒí™©ì„ ì´ˆê¸°í™”í• ê¹Œìš”?')){
        state.cleared=new Set(); state.exp=state.hp=state.mp=0;
        saveState(); renderAll(); upsertMyScore(); showToast('ì´ˆê¸°í™” ì™„ë£Œ!');
      }
    });
    if (closePanelBtn) closePanelBtn.addEventListener('click',()=>{ sfx('click'); closeQuest(); });
    overlay.addEventListener('click',()=>{ sfx('click'); closeQuest(); closeBoard(); closeReward(); closeHint(); });

    function showIntro(){ introScreen.style.display='block'; introScreen.setAttribute('aria-hidden','false'); mapScreen.style.display='none'; mapScreen.setAttribute('aria-hidden','true'); }
    function showMap(){ introScreen.style.display='none'; introScreen.setAttribute('aria-hidden','true'); mapScreen.style.display='block'; mapScreen.setAttribute('aria-hidden','false'); window.scrollTo({top:0, behavior:'smooth'}); }

    // --- ìŠ¤íƒ¯ ---
    function renderMeters(){
      const totalHP=700, totalMP=700, totalXP=STAGES.reduce((s,st)=>s+st.exp,0);
      const c=state.cleared.size;
      const baseHP=Math.min(totalHP, c*100);
      const baseMP=Math.min(totalMP, c*100);
      const baseXP=state.exp;

      const buff = activeBuff();
      let hp=baseHP, mp=baseMP, xp=baseXP;
      if (buff){
        if (buff.stat==='hp') hp = Math.min(totalHP, Math.round(baseHP*(1+buff.pct/100)));
        if (buff.stat==='mp') mp = Math.min(totalMP, Math.round(baseMP*(1+buff.pct/100)));
        if (buff.stat==='exp') xp = Math.min(totalXP, Math.round(baseXP*(1+buff.pct/100)));
      }

      state.hp=baseHP; state.mp=baseMP; // ì €ì¥ê°’ì€ ê¸°ë³¸ê°’ ìœ ì§€

      hpFill.style.width=`${(hp/totalHP)*100}%`; mpFill.style.width=`${(mp/totalMP)*100}%`; xpFill.style.width=`${(xp/totalXP)*100}%`;
      const hpNote = buff && buff.stat==='hp' ? ` (+${buff.pct}%)` : '';
      const mpNote = buff && buff.stat==='mp' ? ` (+${buff.pct}%)` : '';
      const xpNote = buff && buff.stat==='exp'? ` (+${buff.pct}%)` : '';
      hpLabel.textContent=`HP ${hp}/${totalHP}${hpNote}`; mpLabel.textContent=`MP ${mp}/${totalMP}${mpNote}`; xpLabel.textContent=`EXP ${xp}/${totalXP}${xpNote}`;
    }

    // --- ìš”ì¼ ì ê¸ˆ ---
    const params=new URLSearchParams(location.search);
    const FREEPLAY = params.get('freeplay')==='1';
    function getTodayIndex(){ const d=new Date().getDay(); return d===0?6:d-1; } // ì›”=0..ì¼=6
    function isUnlocked(i){ return FREEPLAY || i<=getTodayIndex(); }

    // --- ìŠ¤í…Œì´ì§€ ë Œë” ---
    function renderStages(){
      stageList.innerHTML='';
      const todayIndex=getTodayIndex();

      STAGES.forEach((st,idx)=>{
        const unlocked=isUnlocked(idx);
        const row=document.createElement('div'); row.className='stage panel pixel';
        if (idx===todayIndex) row.classList.add('today');
        if (!unlocked) row.classList.add('locked');
        if (state.cleared.has(st.id)) row.classList.add('cleared');

        if (idx===todayIndex){
          const badge=document.createElement('div');
          badge.className='today-badge';
          badge.textContent='ì˜¤ëŠ˜';
          row.append(badge);
        }

        const node=Object.assign(document.createElement('div'),{className:'node',textContent:st.dayKo});
        const info=document.createElement('div'); info.className='info';
        const lockLabel=!unlocked?' Â· ğŸ”’ ì ê¹€':(state.cleared.has(st.id)?' Â· âœ”ï¸ í´ë¦¬ì–´ë¨':'');
        info.innerHTML=`
          <div class="day">Stage ${st.id} Â· ${st.dayKo}ìš”ì¼</div>
          <div class="text">${st.range}</div>
          <div class="reward">ğŸ† ë³´ìƒ: +${st.exp} EXP <span class="clear">${lockLabel}</span></div>
        `;

        const go=document.createElement('button');
        go.className='go'+(unlocked?'':' lock') + (idx===todayIndex?' primary':'');
        go.textContent=unlocked?(idx===todayIndex?'ğŸš€ ì˜¤ëŠ˜ ì‹œì‘':'ìì„¸íˆ'):'ğŸ”’ ì ê¹€';
        if (!unlocked){ go.disabled=true; go.title='í•´ë‹¹ ìš”ì¼ì— ì—´ë¦½ë‹ˆë‹¤'; }
        go.addEventListener('click',()=>{
          if (!unlocked){ showToast('ğŸ”’ ì•„ì§ ì—´ë¦¬ì§€ ì•Šì•˜ì–´ìš”! í•´ë‹¹ ìš”ì¼ì— ë„ì „í•´ìš”'); sfx('error'); if (navigator.vibrate) navigator.vibrate(30); return; }
          sfx('click'); openQuest(st);
        });

        row.append(node,info,go);
        stageList.appendChild(row);
      });
    }

    // --- í€´ì¦ˆ(ë‹¤ì¤‘ + ì˜¤ë‹µ 3íšŒ íŒíŠ¸) ---
    function getQuizzes(stage){
      if (Array.isArray(stage.quizzes) && stage.quizzes.length) return stage.quizzes;
      const obj = { q: stage.quizQ || 'ì˜¤ëŠ˜ ë³¸ë¬¸ì—ì„œ í•µì‹¬ ë‹¨ì–´ë¥¼ ë§í˜€ë³´ì„¸ìš”!', a: Array.isArray(stage.quizA) ? stage.quizA : [stage.quizA] };
      if (stage.hint) obj.h = stage.hint;
      return [obj];
    }

    function openQuest(stage){
      qpTitle.textContent=`MAIN QUEST Â· ${stage.title}`;
      qpSub.textContent='ì˜¤ëŠ˜ì˜ ë³¸ë¬¸ì„ ì½ê³  ì™„ë£Œë¡œ í‘œì‹œí•´ìš”!';
      qpRange.textContent=stage.range;
      qpReward.textContent=`+${stage.exp} EXP`;
      qpReadLink.href=stage.readLink||'#';

      const quizzes=getQuizzes(stage);
      let qIndex=0;
      let wrongStreak=0;

      function autoHintFromAnswer(ans){
        if (!ans) return 'ë³¸ë¬¸ì„ ë‹¤ì‹œ ì½ê³  í•µì‹¬ ë‹¨ì–´ë¥¼ ì°¾ì•„ë³´ì„¸ìš”!';
        const first = String(ans).trim();
        const firstChar = first[0] || '';
        return `ì •ë‹µì€ ${first.length}ê¸€ì, ì²« ê¸€ìëŠ” â€œ${firstChar}â€ ì…ë‹ˆë‹¤.`;
      }

      function renderQuiz(){
        wrongStreak=0;
        quizQuestion.textContent=`ë¬¸ì œ ${qIndex+1}/${quizzes.length} Â· ${quizzes[qIndex].q}`;
        quizInput.value=''; quizInput.classList.remove('shake','danger');
      }

      function showHint(){
        const cur = quizzes[qIndex];
        const firstAccept = Array.isArray(cur.a) ? cur.a.find(Boolean) : cur.a;
        const hint = cur.h || autoHintFromAnswer(firstAccept);
        hintText.textContent = hint;
        readAgainBtn.href = stage.readLink || '#';
        overlay.classList.add('active','front');
        hintModal.classList.remove('hidden');
        setTimeout(()=>hintModal.classList.add('show'),10);
      }

      quizBox.classList.add('hidden');
      actionBtns.classList.remove('hidden');

      markDoneBtn.textContent='ğŸ§© í€´ì¦ˆ í’€ê³  ì™„ë£Œ';
      markDoneBtn.onclick=()=>{ quizBox.classList.remove('hidden'); actionBtns.classList.add('hidden'); renderQuiz(); setTimeout(()=>quizInput.focus(),0); sfx('click'); };

      submitQuiz.onclick=()=>{
        const ans=(quizInput.value||'').trim().toLowerCase();
        const accepts=Array.isArray(quizzes[qIndex].a)?quizzes[qIndex].a:[quizzes[qIndex].a];
        const ok=accepts.filter(Boolean).map(s=>String(s).trim().toLowerCase()).includes(ans);

        if (ok){
          if (qIndex<quizzes.length-1){ qIndex++; sfx('success'); renderQuiz(); }
          else{
            if (!state.cleared.has(stage.id)){ state.cleared.add(stage.id); state.exp+=stage.exp; saveState(); renderAll(); }
            showVictory(`+${stage.exp} EXP`); actionBtns.classList.remove('hidden'); closeQuest(); upsertMyScore();

            // ğŸ ì˜¤ëŠ˜ì˜ íŠ¹ë³„ ë³´ìƒ: ìë™ìœ¼ë¡œ íŒ¨ë„ë§Œ ì—´ê¸° (í´ë ˆì„ì€ ë²„íŠ¼ìœ¼ë¡œ)
            openReward();
          }
        }else{
          wrongStreak++;
          quizInput.classList.add('shake','danger'); setTimeout(()=>quizInput.classList.remove('shake','danger'),600);
          if (navigator.vibrate) navigator.vibrate([40,40]); sfx('error');

          if (wrongStreak>=3){
            wrongStreak=0;
            showHint();
          }else{
            showToast('ì•—! ë‹¤ì‹œ ì‹œë„í•´ë´ìš”');
          }
        }
      };

      // íŒíŠ¸ ëª¨ë‹¬ ë²„íŠ¼
      closeHintBtn.onclick = ()=>{ sfx('click'); closeHint(); setTimeout(()=>quizInput.focus(),50); };
      readAgainBtn.addEventListener('click', ()=>sfx('click'));

      cancelQuiz.onclick=()=>{ quizBox.classList.add('hidden'); actionBtns.classList.remove('hidden'); sfx('click'); };

      questPanel.classList.add('open'); questPanel.setAttribute('aria-hidden','false');
      document.body.classList.add('lock'); overlay.classList.add('active');
    }

    function closeQuest(){
      questPanel.classList.remove('open'); questPanel.setAttribute('aria-hidden','true');
      quizBox.classList.add('hidden'); actionBtns.classList.remove('hidden');
      if (!boardPanel.classList.contains('open') && !rewardPanel.classList.contains('open') && !hintModal.classList.contains('show')) {
        overlay.classList.remove('active'); document.body.classList.remove('lock');
      }
    }

    function renderAll(){ renderStages(); renderMeters(); }

    // --- ìŠ¤íƒ¯ í† ê¸€ ---
    function applyStatsVisibility(){
      const open=settings.showStats;
      metersEl.classList.toggle('collapsed', !open);
      statsToggleBtn.textContent=open?'ğŸ“Š ìŠ¤íƒ¯ ìˆ¨ê¸°ê¸°':'ğŸ“Š ë‚´ ìŠ¤íƒ¯ ë³´ê¸°';
      statsToggleBtn.setAttribute('aria-expanded', String(open));
    }
    statsToggleBtn.addEventListener('click',()=>{ settings.showStats=!settings.showStats; applyStatsVisibility(); saveSettings(); });

    // --- ë‹‰ë„¤ì„ & ë¦¬ë”ë³´ë“œ ---
    function applyNameUI(){ nameLabel.textContent=settings.nickname||'ê²ŒìŠ¤íŠ¸'; }
    nameBtn.addEventListener('click',()=>{
      const next=prompt('ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš” (1â€“12ì)', settings.nickname||'');
      if (next==null) return;
      const clean=String(next).trim().slice(0,12);
      if (!clean) return alert('ë‹‰ë„¤ì„ì€ 1ì ì´ìƒì´ì–´ì•¼ í•´ìš”!');
      settings.nickname=clean; saveSettings(); applyNameUI(); upsertMyScore(); showToast('ë‹‰ë„¤ì„ì´ ì—…ë°ì´íŠ¸ ë˜ì—ˆì–´ìš”!');
    });

    function loadLeaderboard(){ try{return JSON.parse(localStorage.getItem(LEADER_KEY))||[]}catch(e){return[]} }
    function saveLeaderboard(a){ localStorage.setItem(LEADER_KEY, JSON.stringify(a)); }
    function ensureLeaderboardSeed(){
      let a=loadLeaderboard();
      if (a.length===0){
        a=[
          {name:'ë¯¿ìŒì˜ ìš©ì‚¬',exp:480,updatedAt:Date.now()-86400000*3},
          {name:'ì°¬ì–‘ëŸ¬ë²„',exp:420,updatedAt:Date.now()-86400000*2},
          {name:'ê¸°ë„ì¥ì¸',exp:360,updatedAt:Date.now()-86400000*5},
          {name:'ì§€í˜œìˆ˜ì§‘ê°€',exp:300,updatedAt:Date.now()-86400000*4},
        ];
        saveLeaderboard(a);
      }
    }
    function upsertMyScore(){
      const me=settings.nickname||'ê²ŒìŠ¤íŠ¸';
      let a=loadLeaderboard();
      const i=a.findIndex(r=>r.name===me);
      if (i>=0){ if (state.exp>(a[i].exp||0)) a[i].exp=state.exp; a[i].updatedAt=Date.now(); }
      else { a.push({name:me, exp:state.exp, updatedAt:Date.now()}); }
      saveLeaderboard(a);
    }
    function openBoard(){
      const me=settings.nickname||'ê²ŒìŠ¤íŠ¸';
      const arr=loadLeaderboard().sort((x,y)=>(y.exp||0)-(x.exp||0)).slice(0,10);
      const trophy=i=>i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'';
      const esc=s=>String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
      boardList.innerHTML=arr.map((r,i)=>`${trophy(i)} <strong>${esc(r.name)}</strong> â€” ${r.exp||0} EXP${r.name===me?' â˜…':''}`).map(li=>`<li>${li}</li>`).join('');
      boardPanel.classList.add('open'); boardPanel.setAttribute('aria-hidden','false');
      overlay.classList.add('active'); document.body.classList.add('lock');
    }
    function closeBoard(){
      boardPanel.classList.remove('open'); boardPanel.setAttribute('aria-hidden','true');
      if (!questPanel.classList.contains('open') && !rewardPanel.classList.contains('open') && !hintModal.classList.contains('show')) {
        overlay.classList.remove('active'); document.body.classList.remove('lock');
      }
    }
    document.getElementById('boardBtn').addEventListener('click',()=>{ sfx('click'); openBoard(); });
    document.getElementById('closeBoardBtn').addEventListener('click',()=>{ sfx('click'); closeBoard(); });

    // --- íŒíŠ¸ ë‹«ê¸° (ESC/ì˜¤ë²„ë ˆì´) ---
    function closeHint(){
      hintModal.classList.remove('show');
      overlay.classList.remove('front');
      setTimeout(()=>hintModal.classList.add('hidden'),150);
    }

    // === ğŸ íŠ¹ë³„ ë³´ìƒ ë¡œì§ ===
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)] }

    // ì´ë¯¸ì§€ ì¹´ë“œ ë Œë”ëŸ¬ (imgê°€ ì—†ìœ¼ë©´ ì•ˆë‚´)
    function rewardCardHtml(item){
      if (item.img) {
        return `
          <div class="reward-card">
            <img src="${item.img}" alt="${item.name} ì¹´ë“œ" loading="lazy" />
            <div class="reward-tag">${item.name}</div>
          </div>
        `;
      }
      return `
        <div class="reward-card" style="display:grid;place-items:center;">
          <div style="color:#c8d0ff; font-size:13px; opacity:.9;">ì´ë¯¸ì§€ë¥¼ ì¤€ë¹„í•´ ë„£ì–´ì£¼ì„¸ìš”</div>
        </div>
      `;
    }

    function renderRewardCard(item){
      rewardArt.innerHTML = rewardCardHtml(item);
      const statKo = item.stat==='hp'?'HP(ë¯¿ìŒ)':
                     item.stat==='mp'?'MP(ê¸°ë„ë ¥)':'EXP(ì§€í˜œ)';
      rewardCaption.innerHTML = `
        <div style="text-align:center">
          <div style="font-weight:900;margin-bottom:6px;">${item.name} ì¹´ë“œ</div>
          <div class="subtitle" style="opacity:.95">íŠ¹Sê¸‰ ëŠ¥ë ¥ì¹˜ ã…£<strong>${item.habit}</strong></div>
          <div style="margin-top:8px;font-weight:900;color:#ffd66e">24ì‹œê°„ ë™ì•ˆ ${statKo} <span style="white-space:nowrap;">+${item.pct}%</span> ì¦ê°€!</div>
        </div>
      `;
    }

    function openReward(){
      refreshRewardUI();
      rewardPanel.classList.add('open'); rewardPanel.setAttribute('aria-hidden','false');
      overlay.classList.add('active'); document.body.classList.add('lock');
      const body = rewardPanel.querySelector('.quest-body'); if (body) body.scrollTop = 0;
    }

    function refreshRewardUI(){
      const buff = activeBuff();
      if (buff){
        rewardStatus.textContent = `ì˜¤ëŠ˜ ë³´ìƒ ìˆ˜ë ¹ ì™„ë£Œ! (ë‹¤ì‹œ ë°›ê¸°ëŠ” ìì • ì´í›„)`;
        claimRewardBtn.disabled = true; claimRewardBtn.textContent = 'ë‚´ì¼ ë‹¤ì‹œ';
        renderRewardCard(buff);
      }else{
        rewardStatus.textContent = 'í€´ì¦ˆ í´ë¦¬ì–´ í›„ ë³´ìƒì„ ë°›ì•„ìš” Â· í•˜ë£¨ 1íšŒ';
        claimRewardBtn.disabled = false; claimRewardBtn.textContent = 'âœ¨ íŠ¹ë³„ ë³´ìƒ ë°›ê¸°';
        // ì•ˆë‚´ Placeholder
        rewardArt.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 120">
            <rect width="100%" height="100%" fill="#0b1228"/>
            <text x="160" y="64" fill="#ffd66e" font-size="16" text-anchor="middle" font-family="Galmuri11, system-ui">ë²„íŠ¼ì„ ëˆŒëŸ¬ ì˜¤ëŠ˜ì˜ ì¹´ë“œë¥¼ ë°›ìœ¼ì„¸ìš”!</text>
          </svg>`;
        rewardCaption.textContent = '';
      }
    }

    function closeReward(){
      rewardPanel.classList.remove('open'); rewardPanel.setAttribute('aria-hidden','true');
      if (!questPanel.classList.contains('open') && !boardPanel.classList.contains('open') && !hintModal.classList.contains('show')) {
        overlay.classList.remove('active'); document.body.classList.remove('lock');
      }
    }

    function claimRewardOnce(){
      if (hasBuffToday()){ showToast('ì˜¤ëŠ˜ ë³´ìƒì€ ì´ë¯¸ ë°›ì•˜ì–´ìš”!'); return; }
      rewardArt.classList.add('reward-anim');
      setTimeout(()=>rewardArt.classList.remove('reward-anim'), 850);

      const item = pickRandom(BUFF_POOL);
      setTimeout(()=>{
        buffState.date = localYMD();
        buffState.id   = item.id;
        saveBuff();
        renderRewardCard(item);
        refreshRewardUI();
        renderMeters(); // ë²„í”„ ë°˜ì˜
        sfx('success'); if (navigator.vibrate) navigator.vibrate(35);
        showToast('ğŸ‰ ì˜¤ëŠ˜ì˜ íŠ¹ë³„ ë³´ìƒ ë„ì°©!');
        confettiBurst();
      }, 420);
    }

    // ë³´ìƒ ë²„íŠ¼
    claimRewardBtn.addEventListener('click', ()=>{ sfx('click'); claimRewardOnce(); });
    closeRewardBtn.addEventListener('click', ()=>{ sfx('click'); closeReward(); });

    // --- INIT ---
    loadSettings(); loadState(); loadBuff();
    renderAll(); showIntro();
    applyStatsVisibility(); applyNameUI(); ensureLeaderboardSeed(); upsertMyScore();
    window.addEventListener('click', ensureAudio, { once:true });
    window.addEventListener('keydown', (e)=>{
      if (e.key==='Escape'){
        closeQuest(); closeBoard(); closeReward(); closeHint();
      }
    });
    soundLabel.textContent = settings.sound ? 'ON' : 'OFF';
  });
  </script>
</body>
</html>
